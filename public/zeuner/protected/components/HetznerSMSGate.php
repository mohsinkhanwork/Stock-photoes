<?php

/**
 * Class HetznerSMSGate
 * (c) 2016 Isidor Zeuner
 * distributed under the MIT license without any warranty
 */

class HetznerSMSGate extends CComponent
{

    /**
     * Domain name, used for login
     * @var string
     */
    public $domain = '';

    /**
     * Password, used for login
     * @var string
     */
    public $password = '';

    /**
     * URL of the konsoleH interface provided by Hetzner
     * @var string
     */
    public $url = 'https://konsoleh.your-server.de/';

    private $calling_codes;

    public function init()
    {
        $this->calling_codes = array(
            "+1" => "+1",
            "+20" => "+20",
            "+21" => "+21",
            "+210" => "+210",
            "+211" => "+211",
            "+212" => "+212",
            "+213" => "+213",
            "+215" => "+215",
            "+216" => "+216",
            "+217" => "+217",
            "+218" => "+218",
            "+219" => "+219",
            "+220" => "+220",
            "+221" => "+221",
            "+222" => "+222",
            "+223" => "+223",
            "+224" => "+224",
            "+225" => "+225",
            "+226" => "+226",
            "+227" => "+227",
            "+228" => "+228",
            "+229" => "+229",
            "+230" => "+230",
            "+231" => "+231",
            "+232" => "+232",
            "+233" => "+233",
            "+234" => "+234",
            "+235" => "+235",
            "+236" => "+236",
            "+237" => "+237",
            "+238" => "+238",
            "+239" => "+239",
            "+240" => "+240",
            "+241" => "+241",
            "+242" => "+242",
            "+243" => "+243",
            "+244" => "+244",
            "+245" => "+245",
            "+246" => "+246",
            "+247" => "+247",
            "+248" => "+248",
            "+249" => "+249",
            "+250" => "+250",
            "+251" => "+251",
            "+252" => "+252",
            "+253" => "+253",
            "+254" => "+254",
            "+255" => "+255",
            "+256" => "+256",
            "+257" => "+257",
            "+258" => "+258",
            "+259" => "+259",
            "+260" => "+260",
            "+261" => "+261",
            "+262" => "+262",
            "+263" => "+263",
            "+264" => "+264",
            "+265" => "+265",
            "+266" => "+266",
            "+267" => "+267",
            "+268" => "+268",
            "+269" => "+269",
            "+27" => "+27",
            "+290" => "+290",
            "+291" => "+291",
            "+295" => "+295",
            "+297" => "+297",
            "+298" => "+298",
            "+299" => "+299",
            "+30" => "+30",
            "+31" => "+31",
            "+32" => "+32",
            "+33" => "+33",
            "+34" => "+34",
            "+350" => "+350",
            "+351" => "+351",
            "+352" => "+352",
            "+353" => "+353",
            "+354" => "+354",
            "+355" => "+355",
            "+356" => "+356",
            "+357" => "+357",
            "+358" => "+358",
            "+359" => "+359",
            "+36" => "+36",
            "+37" => "+37",
            "+370" => "+370",
            "+371" => "+371",
            "+372" => "+372",
            "+373" => "+373",
            "+374" => "+374",
            "+375" => "+375",
            "+376" => "+376",
            "+377" => "+377",
            "+378" => "+378",
            "+379" => "+379",
            "+38" => "+38",
            "+380" => "+380",
            "+381" => "+381",
            "+382" => "+382",
            "+383" => "+383",
            "+385" => "+385",
            "+386" => "+386",
            "+387" => "+387",
            "+388" => "+388",
            "+389" => "+389",
            "+39" => "+39",
            "+3906" => "+3906",
            "+40" => "+40",
            "+41" => "+41",
            "+4175" => "+4175",
            "+42" => "+42",
            "+420" => "+420",
            "+421" => "+421",
            "+423" => "+423",
            "+43" => "+43",
            "+44" => "+44",
            "+45" => "+45",
            "+46" => "+46",
            "+47" => "+47",
            "+48" => "+48",
            "+49" => "+49",
            "+500" => "+500",
            "+501" => "+501",
            "+502" => "+502",
            "+503" => "+503",
            "+504" => "+504",
            "+505" => "+505",
            "+506" => "+506",
            "+507" => "+507",
            "+508" => "+508",
            "+509" => "+509",
            "+51" => "+51",
            "+52" => "+52",
            "+53" => "+53",
            "+54" => "+54",
            "+55" => "+55",
            "+56" => "+56",
            "+57" => "+57",
            "+58" => "+58",
            "+590" => "+590",
            "+591" => "+591",
            "+592" => "+592",
            "+593" => "+593",
            "+594" => "+594",
            "+595" => "+595",
            "+596" => "+596",
            "+597" => "+597",
            "+598" => "+598",
            "+599" => "+599",
            "+60" => "+60",
            "+61" => "+61",
            "+62" => "+62",
            "+63" => "+63",
            "+64" => "+64",
            "+65" => "+65",
            "+66" => "+66",
            "+670" => "+670",
            "+671" => "+671",
            "+672" => "+672",
            "+673" => "+673",
            "+674" => "+674",
            "+675" => "+675",
            "+676" => "+676",
            "+677" => "+677",
            "+678" => "+678",
            "+679" => "+679",
            "+680" => "+680",
            "+681" => "+681",
            "+682" => "+682",
            "+683" => "+683",
            "+684" => "+684",
            "+685" => "+685",
            "+686" => "+686",
            "+687" => "+687",
            "+688" => "+688",
            "+689" => "+689",
            "+690" => "+690",
            "+691" => "+691",
            "+692" => "+692",
            "+7" => "+7",
            "+800" => "+800",
            "+808" => "+808",
            "+81" => "+81",
            "+82" => "+82",
            "+84" => "+84",
            "+850" => "+850",
            "+852" => "+852",
            "+853" => "+853",
            "+855" => "+855",
            "+856" => "+856",
            "+86" => "+86",
            "+870" => "+870",
            "+871" => "+871",
            "+874" => "+874",
            "+875" => "+875",
            "+876" => "+876",
            "+877" => "+877",
            "+878" => "+878",
            "+879" => "+879",
            "+880" => "+880",
            "+881" => "+881",
            "+882" => "+882",
            "+883" => "+883",
            "+886" => "+886",
            "+888" => "+888",
            "+90" => "+90",
            "+91" => "+91",
            "+92" => "+92",
            "+93" => "+93",
            "+94" => "+94",
            "+95" => "+95",
            "+960" => "+960",
            "+961" => "+961",
            "+962" => "+962",
            "+963" => "+963",
            "+964" => "+964",
            "+965" => "+965",
            "+966" => "+966",
            "+967" => "+967",
            "+968" => "+968",
            "+969" => "+969",
            "+970" => "+970",
            "+971" => "+971",
            "+972" => "+972",
            "+973" => "+973",
            "+974" => "+974",
            "+975" => "+975",
            "+976" => "+976",
            "+977" => "+977",
            "+978" => "+978",
            "+979" => "+979",
            "+98" => "+98",
            "+991" => "+991",
            "+992" => "+992",
            "+993" => "+993",
            "+994" => "+994",
            "+995" => "+995",
            "+996" => "+996",
            "+998" => "+998",
        );
    }

    /**
     * @param $to string The phone number, including country code, i.e. +49555123
     * @param $message
     * @return mixed $result
     */
    public function send($to, $message)
    {

        $components = $this->split_to($to);

        require_once('sms.php');

        $gateway = new SMS($this->url);

        $gateway_result = $gateway->send(
            $this->domain,
            $this->password,
            $components['country'],
            $components['local'],
            $message
        );

        $result = array(
            'success' => $gateway_result[0],
            'details' => $gateway_result[1],
        );

        Yii::log("Message [$message] sent to [$to] with result: [" . print_r($result, 1) . "]", CLogger::LEVEL_INFO, 'application.external.sms.hetznersms');

        return $result;
    }

    /**
     * split into country calling code and country-wide number
     * @param $to
     * @return mixed
     */
    protected function split_to($to)
    {
        for (
            $length = 2;
            4 >= $length;
            $length++
        ) {
            $tried = substr(
                $to,
                0,
                $length
            );
            if (
                isset(
                    $this->calling_codes[
                        $tried
                    ]
                )
            ) {
                return array(
                    'country' => $tried,
                    'local' => '0' . substr(
                        $to,
                        $length
                    )
                );
            }
        }
        throw new exception(
            "invalid country code " . $tried
        );
    }

}
